<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Beer Ranking App (Advanced + Firebase)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #eee; }
    h1, h2 { color: #ffcc33; }
    input, button, select { padding: 10px; border-radius: 8px; border: none; font-size: 15px; }
    button { background: #ffcc33; color: #000; cursor: pointer; }
    button:hover { opacity: 0.8; }
    .beer-entry { margin: 15px 0; padding: 10px; background: #222; border-radius: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #222; color: #eee; }
    th, td { border: 1px solid #444; padding: 10px; text-align: center; }
    .stars span { font-size: 22px; cursor: pointer; }
    .stars .active { color: gold; }
    .session-box { background:#222; padding:15px; border-radius:10px; margin-bottom:20px; }
    img { max-width: 120px; border-radius: 8px; margin-top: 5px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Beer Ranking App üç∫ (Advanced + Sync)</h1>

  <div class="session-box">
    <h2>Session Manager</h2>
    <select id="sessionSelect"></select>
    <button onclick="deleteSession()">Delete Session</button><br><br>
    <input id="newSessionName" placeholder="New session name" />
    <button onclick="createSession()">Create Session</button>
  </div>

  <h2>Add Beer</h2>
  <input id="beerName" placeholder="Beer name" />
  <input id="beerPhoto" type="file" accept="image/*" />
  <button onclick="addBeer()">Add Beer</button>

  <h2>Current Beers</h2>
  <div id="beerList"></div>

  <h2>Rate Beers</h2>
  <div id="ratingSection"></div>

  <h2>Charts</h2>
  <canvas id="ratingChart"></canvas>

  <h2>Results</h2>
  <button onclick="exportCSV()">Export CSV</button>
  <table>
    <thead><tr><th>Beer</th><th>Average</th></tr></thead>
    <tbody id="resultsTable"></tbody>
  </table>

<script>
// --- Firebase Config (replace with yours) ---
import { initializeApp } from "firebase/app";
import { getDatabase } from "firebase/database";
import { getStorage } from "firebase/storage";

const firebaseConfig = {
  apiKey: "AIzaSyAS52TEatDdFmQGTt4zckN1-9edFqxwsss",
  authDomain: "beerratings.firebaseapp.com",
  projectId: "beerratings",
  storageBucket: "beerratings.firebasestorage.app",
  messagingSenderId: "354337577132",
  appId: "1:354337577132:web:cef0ec4c0bf60dbdc2e709"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let currentSession = null;
let chart = null;

function loadSessions() {
  db.ref('sessions').on('value', snap => {
    const data = snap.val() || {};
    const sel = document.getElementById('sessionSelect');
    sel.innerHTML = Object.keys(data).map(s => `<option>${s}</option>`).join('');
    if (!currentSession && Object.keys(data).length) {
      currentSession = Object.keys(data)[0];
    }
    sel.value = currentSession;
    loadSessionData();
  });
}

function createSession() {
  const name = document.getElementById('newSessionName').value.trim();
  if (!name) return;
  db.ref('sessions/' + name).set({ beers: {} });
  currentSession = name;
  document.getElementById('newSessionName').value = '';
}

function deleteSession() {
  if (!currentSession) return;
  db.ref('sessions/' + currentSession).remove();
}

function loadSessionData() {
  db.ref('sessions/' + currentSession + '/beers').on('value', snap => {
    const beers = snap.val() || {};
    renderBeers(beers);
    renderRatings(beers);
    updateResults(beers);
    updateChart(beers);
  });
}

async function addBeer() {
  const name = document.getElementById('beerName').value.trim();
  const file = document.getElementById('beerPhoto').files[0];
  if (!name) return;

  let photoURL = '';
  if (file) {
    const ref = storage.ref(`beer_photos/${currentSession}_${name}`);
    await ref.put(file);
    photoURL = await ref.getDownloadURL();
  }

  db.ref(`sessions/${currentSession}/beers/${name}`).set({ ratings: {}, photo: photoURL });

  document.getElementById('beerName').value = '';
  document.getElementById('beerPhoto').value = '';
}

function renderBeers(beers) {
  const div = document.getElementById('beerList');
  div.innerHTML = Object.entries(beers).map(([name, b]) => `
    <div class='beer-entry'>
      <strong>${name}</strong><br>
      ${b.photo ? `<img src="${b.photo}">` : ''}<br>
      <button onclick="deleteBeer('${name}')">Delete</button>
    </div>
  `).join('');
}

function deleteBeer(name) {
  db.ref(`sessions/${currentSession}/beers/${name}`).remove();
}

function renderRatings(beers) {
  const div = document.getElementById('ratingSection');
  div.innerHTML = Object.entries(beers).map(([name, b]) => `
    <div class='beer-entry'>
      <strong>${name}</strong><br>
      <div class="stars">
        ${[1,2,3,4,5].map(n => `<span onclick=\"rate('${name}',${n})\">‚òÖ</span>`).join('')}
      </div>
      <textarea placeholder="Comment" id="comment-${name}"></textarea>
    </div>
  `).join('');
}

function rate(name, stars) {
  const comment = document.getElementById(`comment-${name}`).value;
  const user = "user_" + Math.random().toString(36).substring(2,8);
  db.ref(`sessions/${currentSession}/beers/${name}/ratings/${user}`).set({ stars, comment });
}

function updateResults(beers) {
  const table = document.getElementById('resultsTable');
  table.innerHTML = Object.entries(beers).map(([name, b]) => {
    const vals = Object.values(b.ratings || {}).map(r => r.stars);
    const avg = vals.length ? (vals.reduce((a,c)=>a+c,0) / vals.length).toFixed(2) : '‚Äî';
    return `<tr><td>${name}</td><td>${avg}</td></tr>`;
  }).join('');
}

function exportCSV() {
  db.ref(`sessions/${currentSession}/beers`).once('value', snap => {
    const beers = snap.val() || {};
    let csv = "Beer,Average\n";
    Object.entries(beers).forEach(([name, b]) => {
      const vals = Object.values(b.ratings || {}).map(r => r.stars);
      const avg = vals.length ? (vals.reduce((a,c)=>a+c,0) / vals.length).toFixed(2) : '';
      csv += `${name},${avg}\n`;
    });
    const blob = new Blob([csv], { type:'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = currentSession + '_ratings.csv';
    a.click();
  });
}

function updateChart(beers) {
  const labels = Object.keys(beers);
  const data = labels.map(name => {
    const vals = Object.values(beers[name].ratings || {}).map(r => r.stars);
    return vals.length ? vals.reduce((a,c)=>a+c,0) / vals.length : 0;
  });

  const ctx = document.getElementById('ratingChart');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Average Rating', data }] },
    options: { scales:{ y:{ beginAtZero:true, max:5 } } }
  });
}

loadSessions();
</script>
</body>
</html>
